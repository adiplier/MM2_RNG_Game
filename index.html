<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM2 RNG Game</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="back">
    <div class="centerbox">
        <div class="container"></div>
        <button id="btnPlay" onclick="funPlay()">Play</button>
        <button id="btnReset" onclick="funReset()">Restart</button>
        <textarea class="output" name="" id="output" rows="10" disabled></textarea>
    </div>
</body>
<script>
    const modifiers = {
        Superb: {
            mPlus: 4,
            mMinus: 0.2,
            mRarity: 6
        },
        Shiny: {
            mPlus: 3,
            mMinus: 0,
            mRarity: 1
        },
        Spotless: {
            mPlus: 1.5,
            mMinus: 0.5,
            mRarity: 10
        },
        Scratched: {
            mPlus: 0.8,
            mMinus: 1.2,
            mRarity: 10
        },
        Shaky: {
            mPlus: 0.75,
            mMinus: 1.25,
            mRarity: 8
        },
        Slow: {
            mPlus: 0.7,
            mMinus: 1.3,
            mRarity: 13
        },
        Smoking: {
            mPlus: 0.5,
            mMinus: 1.5,
            mRarity: 13
        },
        Wrecked: {
            mPlus: -0.1,
            mMinus: 1.5,
            mRarity: 2
        },
        Schizophrenic: {
            mPlus: -5,
            mMinus: -10,
            mRarity: 3
        },
        Standard: {
            mPlus: 1,
            mMinus: 1,
            mRarity: 30
        }
    }
    const carlist = {
        vpgtr: {
            vName:"GTR",
            vDesc:"Race Car",
            vFullDesc:"30% 70 points, 70% -60 points",
            vScore: function() {
                let score = 70;
                let roll = Math.floor(Math.random() * 100);
                if(roll>29){score = -60;}
                return score;
            }
        },
        vppanoz: {
            vName:"Panoz",
            vDesc:"Stylish Car",
            vFullDesc:"40% 60 points, 60% -50 points",
            vScore: function() {
                let score = 60;
                let roll = Math.floor(Math.random() * 100);
                if(roll>39){score = -50;}
                return score;
            }
        },
        vpbug: {
            vName:"Beetle",
            vDesc:"Family Car",
            vFullDesc:"45% 55 points, 55% -45 points",
            vScore: function() {
                let score = 55;
                let roll = Math.floor(Math.random() * 100);
                if(roll>44){score = -45;}
                return score;
            }
        },
        vpmustang: {
            vName:"Mustang",
            vDesc:"Muscle Car",
            vFullDesc:"50% 50 points, 50% -50 points",
            vScore: function() {
                let score = 50;
                let roll = Math.floor(Math.random() * 100);
                if(roll>49){score = -50;}
                return score;
            }
        },
        vpbus: {
            vName:"Bus",
            vDesc:"Public Transport",
            vFullDesc:"60% 20 points, 40% -20 points",
            vScore: function() {
                let score = 20;
                let roll = Math.floor(Math.random() * 100);
                if(roll>59){score = -20;}
                return score;
            }
        },
        vpcentury: {
            vName:"Freightliner",
            vDesc:"Supply Truck",
            vFullDesc:"95% 10 points, 5% -30 points",
            vScore: function() {
                let score = 10;
                let roll = Math.floor(Math.random() * 100);
                if(roll>94){score = -30;}
                return score;
            }
        }
    };

    const initVars = {
        numBoxGen: 3,
        points: 100,
        expenseX: 10,
        selFlag: 0,
        turns: 1,
        expenseTurns: 5,
        maxTurns: 50,
        winPoints: 5000
    };

    // let gameVars = Object.create(initVars);
    let gameVars = {...initVars};

    const cont = document.querySelector(".container");
    for(let i=0; i<gameVars.numBoxGen; i++){
        cont.innerHTML += `
        <div class="wrapper" data-peer-div="${i}" data-xp="0" data-lvl="1">
            <select onchange="funDetails(this)" data-peer="${i}"></select>
            <p class="desc" data-peer-text="${i}">Standard ${carlist[Object.keys(carlist)[0]].vDesc} \nLVL 1</p>
        </div>
        `;
    }
    const disPT = document.querySelectorAll('[data-peer-text]');
    const vehWraps = document.querySelectorAll('[data-peer-div]');
    const output = document.getElementById("output");
    const btnPlay = document.getElementById("btnPlay");
    const btnReset = document.getElementById("btnReset");
    
    function funDisableSel() {
        let dropdowns = document.querySelectorAll('[data-peer]');
        for(let i in dropdowns){
            if(dropdowns[i].options){
                dropdowns[i].setAttribute("disabled", "disabled");
            }
        }
    }
    function funEnableSel() {
        let dropdowns = document.querySelectorAll('[data-peer]');
        for(let i in dropdowns){
            if(dropdowns[i].options){
                dropdowns[i].removeAttribute("disabled");
            }
        }
    }

    function funRandomModSel() {
        if(gameVars.selFlag){
            let total = 0;
            for(let i in modifiers){
                total += modifiers[i].mRarity;
            }
            // let roll = Math.floor(Math.random() * total);
            let roll = Math.random() * total;
            for(i in modifiers) {
                if(roll <= modifiers[i].mRarity){
                    return i;
                }
                roll -= modifiers[i].mRarity;
            }
        }
        return "Standard";   
    }

    function funDetails(e) {
        let vSelected = e.options[e.selectedIndex].value;
        let aSelected = e.getAttribute("data-peer");
        disPT[aSelected].innerHTML = funRandomModSel() + " " + carlist[vSelected].vDesc;
        disPT[aSelected].innerHTML += "\nLVL " + vehWraps[aSelected].getAttribute("data-lvl");
        if(gameVars.selFlag){
            funDisableSel();
        }
        // console.log(aSelected);
    }

    function funRecExpense() {
        let currentTurn = gameVars.turns - 1;
        let pointsSubtracted = (gameVars.expenseX * currentTurn);
        if(currentTurn%gameVars.expenseTurns == gameVars.expenseTurns-1){
            output.innerHTML += `\nExpense of ${pointsSubtracted+gameVars.expenseX} coming up!\n`;
        }
        if(currentTurn%gameVars.expenseTurns == 0){
            output.innerHTML += `\nBusiness Expense ${gameVars.points} - ${pointsSubtracted} \n`;
            gameVars.points -= pointsSubtracted;
        }
    }
    
    function funPlay() {
        let dropdowns = document.querySelectorAll('[data-peer]');
        let temp = 0;
        gameVars.selFlag = 1;
        output.innerHTML += `Turn ${gameVars.turns}:-\n`;
        gameVars.turns+=1;
        for(let i in dropdowns){
            if(dropdowns[i].options){
                output.innerHTML += `${dropdowns[i].options[dropdowns[i].selectedIndex].innerHTML} `;
                temp = carlist[dropdowns[i].options[dropdowns[i].selectedIndex].value].vScore();
                if(temp>0){temp = temp * (modifiers[disPT[i].innerHTML.split(" ", 1).toString()].mPlus)}
                else{temp = temp * (modifiers[disPT[i].innerHTML.split(" ", 1).toString()].mMinus)}
                temp = Math.floor(temp);
                output.innerHTML += `${temp} `;
                // output.innerHTML += `${carlist[dropdowns[i].options[dropdowns[i].selectedIndex].value].vScore()} `;
                gameVars.points += temp;
            }
        }
        funRecExpense();
        output.innerHTML += `${gameVars.points}`;
        output.innerHTML += `\n`;
        output.scrollTop = output.scrollHeight;

        funEnableSel();

        if(gameVars.points<1 || gameVars.turns>=gameVars.maxTurns){
            btnPlay.disabled = true;
            output.innerHTML += `Game Over`;
            setTimeout( ()=> {
                btnPlay.setAttribute('style', 'display: none');
                btnReset.setAttribute('style', 'display: initial');} , 600);
            funDisableSel();
        }
        if(gameVars.points>=gameVars.winPoints){
            btnPlay.disabled = true;
            output.innerHTML += `You Won on Turn ${gameVars.turns} with ${gameVars.points} Points!!`;
            setTimeout( ()=> {
                btnPlay.setAttribute('style', 'display: none');
                btnReset.setAttribute('style', 'display: initial');} , 600);
            funDisableSel();
        }
    }
    
    function funReset() {
        
        Object.keys(gameVars).forEach(key => {
        gameVars[key] = initVars[key];
        });
        
        let dropdowns = document.querySelectorAll('[data-peer]');
        for(let i in dropdowns){
            if(dropdowns[i].options){
                funDetails(dropdowns[i]);
            }
        }
        funEnableSel();
        
        btnReset.setAttribute('style', 'display: none');
        btnPlay.setAttribute('style', 'display: initial');
        btnPlay.disabled = false;
        output.innerHTML = `Your Starting Points are ${gameVars.points}\n`;
    }

    window.onload = (event) => {
        let dropdowns = document.querySelectorAll('[data-peer]');
        for (let i in dropdowns){
            for(let j in carlist){
                if(dropdowns[i].options)
                    dropdowns[i].options[dropdowns[i].options.length] = new Option(carlist[j].vName, j);
            }
        } 
        // console.log(dropdowns);
        output.innerHTML += `Your Starting Points are ${gameVars.points}\n`;
    };
</script>
</html>